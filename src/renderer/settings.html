<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>UsageBar Settings</title>
  <style>
    :root {
      --bg-color: #f5f5f7;
      --sidebar-bg: #e8e8ed;
      --card-bg: #ffffff;
      --text-primary: #1d1d1f;
      --text-secondary: #86868b;
      --accent: #0071e3;
      --border: #d2d2d7;
      --danger: #ff3b30;
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      font-family: var(--font-family);
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      background: var(--bg-color);
      color: var(--text-primary);
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding-top: 20px;
    }

    .sidebar-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      padding: 0 20px 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .nav-item {
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: background 0.1s;
      font-size: 14px;
      color: var(--text-primary);
    }

    .nav-item:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .nav-item.active {
      background: rgba(0, 0, 0, 0.1);
      font-weight: 500;
    }

    .nav-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .nav-icon svg {
      width: 16px;
      height: 16px;
    }

    /* Main Content */
    .main {
      flex: 1;
      padding: 30px 40px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .header {
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
    }

    /* Forms */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .form-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }

    .form-hint {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 6px;
      line-height: 1.4;
    }

    /* Toggles */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .toggle-row:last-child {
      border-bottom: none;
    }

    .toggle-label {
      font-size: 14px;
      font-weight: 500;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input:checked+.slider {
      background-color: var(--accent);
    }

    input:checked+.slider:before {
      transform: translateX(16px);
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: #0077ed;
    }

    .btn-secondary {
      background: white;
      border-color: var(--border);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: #fafafa;
    }

    .btn-danger {
      color: var(--danger);
      background: rgba(255, 59, 48, 0.1);
    }

    .btn-danger:hover {
      background: rgba(255, 59, 48, 0.2);
    }

    /* Provider Colors */
    .bg-antigravity {
      background: transparent;
    }

    .bg-cursor {
      background: #000000;
    }

    .bg-claude {
      background: #d97757;
    }

    .bg-codex {
      background: #10a37f;
    }

    .bg-copilot {
      background: #000000;
    }

    .bg-gemini {
      background: linear-gradient(135deg, #4285f4, #ea4335);
    }

    .bg-factory {
      background: #f59e0b;
    }

    .bg-zai {
      background: #ec4899;
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <div class="sidebar-title">Providers</div>
    <div id="nav-list"></div>
    <div style="flex:1"></div>
    <div class="sidebar-title">General</div>
    <div class="nav-item" id="nav-general">
      <div class="nav-icon" style="background:#888"><svg fill="#fff" viewBox="0 0 24 24">
          <path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm0 6a2 2 0 1 1 0-4 2 2 0 0 1 0 4z" />
          <path
            d="M20 12c0-4.42-3.58-8-8-8S4 7.58 4 12s3.58 8 8 8 8-3.58 8-8zM6 12c0-3.31 2.69-6 6-6s6 2.69 6 6-2.69 6-6 6-6-2.69-6-6z" />
        </svg></div>
      General
    </div>
  </div>

  <div class="main">
    <div class="header">
      <div class="page-title" id="page-title">Settings</div>
      <button class="btn btn-primary" id="btn-save">Save Changes</button>
    </div>
    <div id="content-area"></div>
  </div>

  <script>
    const ipc = window.usagebar;

    // Exact same SVGs as tray.html
    const svgs = {
      antigravity: '<img src="antigravity.png" style="width:20px;height:20px;object-fit:contain;">',
      cursor: '<svg fill="#fff" viewBox="0 0 24 24"><path d="M11.503.131 1.891 5.678a.84.84 0 0 0-.42.726v11.188c0 .3.162.575.42.724l9.609 5.55a1 1 0 0 0 .998 0l9.61-5.55a.84.84 0 0 0 .42-.724V6.404a.84.84 0 0 0-.42-.726L12.497.131a1.01 1.01 0 0 0-.996 0M2.657 6.338h18.55c.263 0 .43.287.297.515L12.23 22.918c-.062.107-.229.064-.229-.06V12.335a.59.59 0 0 0-.295-.51l-9.11-5.257c-.109-.063-.064-.23.061-.23"/></svg>',
      claude: '<svg fill="#fff" viewBox="0 0 16 16"><path d="m3.127 10.604 3.135-1.76.053-.153-.053-.085H6.11l-.525-.032-1.791-.048-1.554-.065-1.505-.08-.38-.081L0 7.832l.036-.234.32-.214.455.04 1.009.069 1.513.105 1.097.064 1.626.17h.259l.036-.105-.089-.065-.068-.064-1.566-1.062-1.695-1.121-.887-.646-.48-.327-.243-.306-.104-.67.435-.48.585.04.15.04.593.456 1.267.981 1.654 1.218.242.202.097-.068.012-.049-.109-.181-.9-1.626-.96-1.655-.428-.686-.113-.411a2 2 0 0 1-.068-.484l.496-.674L4.446 0l.662.089.279.242.411.94.666 1.48 1.033 2.014.302.597.162.553.06.17h.105v-.097l.085-1.134.157-1.392.154-1.792.052-.504.25-.605.497-.327.387.186.319.456-.045.294-.19 1.23-.37 1.93-.243 1.29h.142l.161-.16.654-.868 1.097-1.372.484-.545.565-.601.363-.287h.686l.505.751-.226.775-.707.895-.585.759-.839 1.13-.524.904.048.072.125-.012 1.897-.403 1.024-.186 1.223-.21.553.258.06.263-.218.536-1.307.323-1.533.307-2.284.54-.028.02.032.04 1.029.098.44.024h1.077l2.005.15.525.346.315.424-.053.323-.807.411-3.631-.863-.872-.218h-.12v.073l.726.71 1.331 1.202 1.667 1.55.084.383-.214.302-.226-.032-1.464-1.101-.565-.497-1.28-1.077h-.084v.113l.295.432 1.557 2.34.08.718-.112.234-.404.141-.444-.08-.911-1.28-.94-1.44-.759-1.291-.093.053-.448 4.821-.21.246-.484.186-.403-.307-.214-.496.214-.98.258-1.28.21-1.016.19-1.263.112-.42-.008-.028-.092.012-.953 1.307-1.448 1.957-1.146 1.227-.274.109-.477-.247.045-.44.266-.39 1.586-2.018.956-1.25.617-.723-.004-.105h-.036l-4.212"/></svg>',
      codex: '<svg fill="#fff" viewBox="0 0 24 24"><path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0843 3.5366-1.9718a3.1835 3.1835 0 0 0 1.126-4.393L13.7376 11.9l2.9536-1.6456 1.0772 1.8545a4.502 4.502 0 0 1-4.5085 7.7122zm-5.0235-.7778-3.5366-1.9718a3.1793 3.1793 0 0 0-.0079-6.3905l2.4277-.4423L8.673 13.197l2.8842 1.764L10.08 17.61a4.498 4.498 0 0 1-1.8436 4.0414zM2.48 10.9085a4.4722 4.4722 0 0 1 .6722-4.3733l2.8532 1.6376L3.9213 11.16a3.1823 3.1823 0 0 0 3.75 3.999l2.259-.8776-1.957-1.129 1.4509-2.5273L3.1019 13.918a4.4752 4.4752 0 0 1-.6219-3.0095zm4.9736-5.8338a4.4959 4.4959 0 0 1 4.1955-1.6322l-1.0763 1.856-1.4509 2.5259-.9736-.576a3.1906 3.1906 0 0 0-4.3262 1.39l-2.9536-1.647 3.5366-1.9723a4.483 4.483 0 0 1 3.0485.0556zm8.8548.3377a3.1769 3.1769 0 0 0-2.6775-3.5413l1.8329-3.1586 1.4509-2.5259 3.3789 2.062a4.4949 4.4949 0 0 1 .9153 6.0759l-3.5366 1.9718L13.7376 3.953l2.5694 1.4604zm4.5052 5.3764-2.8532-1.6376 2.0832-2.9868a3.1812 3.1812 0 0 0-3.7482-3.9976L13.847 2.7667l1.957 1.1306-1.4509 2.5273 6.3225-3.2926a4.4714 4.4714 0 0 1 .1379 2.1368z"/></svg>',
      copilot: '<svg fill="#fff" viewBox="0 0 24 24"><path d="M23.922 16.997C23.061 18.492 18.063 22.02 12 22.02 5.937 22.02.939 18.492.078 16.997A.641.641 0 0 1 0 16.741v-2.869a.883.883 0 0 1 .053-.22c.372-.935 1.347-2.292 2.605-2.656.167-.429.414-1.055.644-1.517a10.098 10.098 0 0 1-.052-1.086c0-1.331.282-2.499 1.132-3.368.397-.406.89-.717 1.474-.952C7.255 2.937 9.248 1.98 11.978 1.98c2.731 0 4.767.957 6.166 2.093.584.235 1.077.546 1.474.952.85.869 1.132 2.037 1.132 3.368 0 .368-.014.733-.052 1.086.23.462.477 1.088.644 1.517 1.258.364 2.233 1.721 2.605 2.656a.841.841 0 0 1 .053.22v2.869a.641.641 0 0 1-.078.256Zm-11.75-5.992h-.344a4.359 4.359 0 0 1-.355.508c-.77.947-1.918 1.492-3.508 1.492-1.725 0-2.989-.359-3.782-1.259a2.137 2.137 0 0 1-.085-.104L4 11.746v6.585c1.435.779 4.514 2.179 8 2.179 3.486 0 6.565-1.4 8-2.179v-6.585l-.098-.104s-.033.045-.085.104c-.793.9-2.057 1.259-3.782 1.259-1.59 0-2.738-.545-3.508-1.492a4.359 4.359 0 0 1-.355-.508Zm2.328 3.25c.549 0 1 .451 1 1v2c0 .549-.451 1-1 1-.549 0-1-.451-1-1v-2c0-.549.451-1 1-1Zm-5 0c.549 0 1 .451 1 1v2c0 .549-.451 1-1 1-.549 0-1-.451-1-1v-2c0-.549.451-1 1-1Zm3.313-6.185c.136 1.057.403 1.913.878 2.497.442.544 1.134.938 2.344.938 1.573 0 2.292-.337 2.657-.751.384-.435.558-1.15.558-2.361 0-1.14-.243-1.847-.705-2.319-.477-.488-1.319-.862-2.824-1.025-1.487-.161-2.192.138-2.533.529-.269.307-.437.808-.438 1.578v.021c0 .265.021.562.063.893Zm-1.626 0c.042-.331.063-.628.063-.894v-.02c-.001-.77-.169-1.271-.438-1.578-.341-.391-1.046-.69-2.533-.529-1.505.163-2.347.537-2.824 1.025-.462.472-.705 1.179-.705 2.319 0 1.211.175 1.926.558 2.361.365.414 1.084.751 2.657.751 1.21 0 1.902-.394 2.344-.938.475-.584.742-1.44.878-2.497Z"/></svg>',
      gemini: '<svg viewBox="0 0 24 24" fill="#fff"><path d="M12 0 C 12 8 17 12 24 12 C 17 12 12 17 12 24 C 12 17 8 12 0 12 C 8 12 12 8 12 0 Z"/></svg>', // Official Gemini Sparkle
      factory: '<svg viewBox="0 0 24 24" fill="#fff"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h6a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h6V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5A2.5 2.5 0 0 0 7.5 18A2.5 2.5 0 0 0 10 15.5A2.5 2.5 0 0 0 7.5 13M16.5 13A2.5 2.5 0 0 0 14 15.5A2.5 2.5 0 0 0 16.5 18A2.5 2.5 0 0 0 19 15.5A2.5 2.5 0 0 0 16.5 13Z"/></svg>', // Robot/Droid Head
      zai: '<svg viewBox="0 0 24 24" fill="#fff"><path d="M4 6h16v3h-10.5l10.5 10v3h-16v-3h10.5l-10.5-10v-3z"/></svg>' // Bold Z
    };

    const providersMeta = {
      antigravity: { name: 'Antigravity', svg: svgs.antigravity, bg: 'bg-antigravity' },
      cursor: { name: 'Cursor', svg: svgs.cursor, bg: 'bg-cursor' },
      claude: { name: 'Claude', svg: svgs.claude, bg: 'bg-claude' },
      codex: { name: 'Codex', svg: svgs.codex, bg: 'bg-codex' },
      copilot: { name: 'Copilot', svg: svgs.copilot, bg: 'bg-copilot' },
      gemini: { name: 'Gemini', svg: svgs.gemini, bg: 'bg-gemini' },
      factory: { name: 'Factory', svg: svgs.factory, bg: 'bg-factory' },
      zai: { name: 'z.ai', svg: svgs.zai, bg: 'bg-zai' }
    };

    let settings = {};
    let activeNav = 'general';

    function renderNav() {
      const list = document.getElementById('nav-list');
      list.innerHTML = '';

      const priority = ['antigravity', 'cursor', 'claude', 'codex', 'copilot', 'gemini', 'factory', 'zai'];
      priority.forEach(id => {
        const meta = providersMeta[id];
        const item = document.createElement('div');
        item.className = `nav-item ${activeNav === id ? 'active' : ''}`;
        item.onclick = () => { activeNav = id; renderPage(); renderNav(); };

        const iconDiv = document.createElement('div');
        iconDiv.className = `nav-icon ${meta.bg}`;
        iconDiv.innerHTML = meta.svg;

        item.appendChild(iconDiv);
        item.appendChild(document.createTextNode(meta.name));
        list.appendChild(item);
      });

      const genItem = document.getElementById('nav-general');
      genItem.className = `nav-item ${activeNav === 'general' ? 'active' : ''}`;
      genItem.onclick = () => { activeNav = 'general'; renderPage(); renderNav(); };
    }

    function renderPage() {
      const content = document.getElementById('content-area');
      const title = document.getElementById('page-title');
      content.innerHTML = '';

      if (activeNav === 'general') {
        title.textContent = 'General Settings';
        const currentInterval = settings.refreshInterval || 5;
        content.innerHTML = `
          <div class="form-group">
            <label class="form-label">Refresh Interval</label>
            <select id="gen-interval" class="form-select">
              <option value="1" ${currentInterval === 1 ? 'selected' : ''}>1 minute</option>
              <option value="2" ${currentInterval === 2 ? 'selected' : ''}>2 minutes</option>
              <option value="5" ${currentInterval === 5 ? 'selected' : ''}>5 minutes</option>
              <option value="10" ${currentInterval === 10 ? 'selected' : ''}>10 minutes</option>
              <option value="15" ${currentInterval === 15 ? 'selected' : ''}>15 minutes</option>
              <option value="30" ${currentInterval === 30 ? 'selected' : ''}>30 minutes</option>
            </select>
            <div class="form-hint">How often the app fetches your usage data from providers.</div>
          </div>
          <div class="form-group">
             <label class="toggle-row">
               <span class="toggle-label">Reset Session Usage Daily</span>
               <label class="switch">
                 <input type="checkbox" id="gen-reset" ${settings.resetDaily ? 'checked' : ''}>
                 <span class="slider"></span>
               </label>
             </label>
             <div class="form-hint">Automatically resets your "Session" meter every 24 hours.</div>
          </div>
          <div class="header" style="margin-top:40px; margin-bottom:10px;">
             <div class="page-title" style="font-size:18px">Reset Data</div>
          </div>
          <div class="form-group">
            <button class="btn btn-danger" id="btn-reset-all">Reset All Usage Data</button>
            <div class="form-hint">Clears all stored usage history for all providers.</div>
          </div>
        `;
        document.getElementById('gen-interval').onchange = (e) => {
          settings.refreshInterval = parseInt(e.target.value, 10);
          ipc.saveSettings(settings);
        };
        document.getElementById('gen-reset').onchange = (e) => settings.resetDaily = e.target.checked;
        document.getElementById('btn-reset-all').onclick = () => {
          if (confirm('Are you sure you want to reset all usage data?')) {
            ipc.resetAllUsage();
            alert('Usage data has been reset.');
          }
        };
      } else {
        const id = activeNav;
        const meta = providersMeta[id];
        const pSettings = settings[id] || {};

        title.textContent = meta.name;

        // Check if this provider is in enabledProviders
        const isEnabled = (settings.enabledProviders || []).includes(id);

        let html = `
          <div class="form-group">
             <label class="toggle-row">
               <span class="toggle-label">Enable Provider</span>
               <label class="switch">
                 <input type="checkbox" id="p-enabled" ${isEnabled ? 'checked' : ''}>
                 <span class="slider"></span>
               </label>
             </label>
          </div>
        `;

        // Custom fields based on provider type
        if (id === 'cursor') {
          html += createInput('Auth Token (Optional)', 'p-token', pSettings.authToken || '', 'text', 'Leave empty to auto-detect');
        } else if (id === 'claude' || id === 'codex' || id === 'gemini') {
          html += createInput('API Key', 'p-key', pSettings.apiKey || '', 'password');
        }

        content.innerHTML = html;

        const enabledCheck = document.getElementById('p-enabled');
        if (enabledCheck) enabledCheck.onchange = (e) => {
          // Ensure enabledProviders array exists
          if (!settings.enabledProviders) settings.enabledProviders = [];

          if (e.target.checked) {
            // Add to enabledProviders if not already there
            if (!settings.enabledProviders.includes(id)) {
              settings.enabledProviders.push(id);
            }
          } else {
            // Remove from enabledProviders
            settings.enabledProviders = settings.enabledProviders.filter(p => p !== id);
          }

          // Immediately save and broadcast to tray
          ipc.saveSettings(settings);
        };

        const tokenInput = document.getElementById('p-token');
        if (tokenInput) tokenInput.oninput = (e) => {
          if (!settings[id]) settings[id] = {};
          settings[id].authToken = e.target.value;
        };

        const keyInput = document.getElementById('p-key');
        if (keyInput) keyInput.oninput = (e) => {
          if (!settings[id]) settings[id] = {};
          settings[id].apiKey = e.target.value;
        };
      }
    }

    function createInput(label, id, value, type = 'text', hint = '') {
      return `
        <div class="form-group">
          <label class="form-label">${label}</label>
          <input type="${type}" id="${id}" class="form-input" value="${value}" placeholder="${hint}">
          ${hint ? `<div class="form-hint">${hint}</div>` : ''}
        </div>
      `;
    }

    document.getElementById('btn-save').onclick = () => {
      ipc.saveSettings(settings); // Send back to main
      alert('Settings saved!');
    };

    // Load initial settings
    ipc.getSettings().then(s => {
      settings = s || {};
      renderNav();
      renderPage();
    });
  </script>
</body>

</html>