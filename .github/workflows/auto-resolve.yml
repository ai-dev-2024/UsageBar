name: Auto-Resolve Issues

on:
  release:
    types: [published]

permissions:
  issues: write
  pull-requests: write

jobs:
  resolve-related-issues:
    runs-on: ubuntu-latest
    if: startsWith(github.event.release.tag_name, 'v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release version
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Find and close related issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.search.issuesAndPullRequests({
              q: 'repo:${{ github.repository }} is:issue is:open -linked:pr in:body release-mention',
              per_page: 100
            });

            let closed = 0;
            for (const issue of issues.data.items) {
              try {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'completed'
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: 'âœ… This issue has been resolved and closed by release **${{ steps.version.outputs.VERSION }}** ðŸŽ‰'
                });

                closed++;
              } catch (error) {
                console.log(`Failed to close issue #${issue.number}: ${error.message}`);
              }
            }

            console.log(`Closed ${closed} issues`);
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Link release to issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.search.issuesAndPullRequests({
              q: 'repo:${{ github.repository }} is:issue is:open linked:pr merged:true',
              per_page: 100
            });

            for (const issue of issues.data.items) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'ðŸ”— This issue is linked to merged PRs and will be included in the next release.'
              });
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify stakeholders
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });

            const release = releases[0];

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: release.target_commitish,
              body: 'ðŸš€ Release **${{ steps.version.outputs.VERSION }}** has been published successfully! ðŸŽ‰\n\nThank you to all contributors!'
            });
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post to GitHub Discussion
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: discussions } = await github.rest.graphql(`
                query($owner: String!, $repo: String!) {
                  repository(owner: $owner, name: $repo) {
                    discussionCategories(first: 10) {
                      nodes {
                        id
                        name
                      }
                    }
                  }
                }
              `, {
                owner: context.repo.owner,
                repo: context.repo.repo
              });

              const annCategory = discussions.data.repository.discussionCategories.nodes.find(
                c => c.name.toLowerCase().includes('announcement')
              );

              if (annCategory) {
                await github.rest.graphql(`
                  mutation($repositoryId: ID!, $title: String!, $body: String!, $categoryId: ID!) {
                    createDiscussion(input: {
                      repositoryId: $repositoryId,
                      title: $title,
                      body: $body,
                      categoryId: $categoryId
                    }) {
                      discussion {
                        id
                      }
                    }
                  }
                `, {
                  repositoryId: context.repo.oid,
                  title: `ðŸš€ UsageBar ${{ steps.version.outputs.VERSION }} Released!`,
                  body: `## What's New\n\nSee [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for full details.\n\n### Quick Links\n- [Download Release](${{ github.event.release.html_url }})\n- [Report Issues](https://github.com/${{ github.repository }}/issues)\n\nThank you for using UsageBar! ðŸŽ‰`,
                  categoryId: annCategory.id
                });
              }
            } catch (error) {
              console.log('Discussion creation skipped:', error.message);
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ignore_errors: true
